<!-- Page header -->
<div class="page-header d-print-none">
  <div class="container-xl">
    <div class="row g-2 align-items-center">
      <div class="col">
        <!-- Page pre-title -->
        <div class="page-pretitle"> Project </div>
        <h2 class="page-title"> {{data.project.name}}
        </h2>
      </div>
      <!-- Page title actions -->
      <div class="col-auto ms-auto d-print-none">
        <div class="btn-list">
          <a href="#" class="btn btn-secondary-outline d-none d-md-inline-block" onclick="toggleLayout(this)">
            <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none"
              stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"
              class="icon icon-tabler icons-tabler-outline icon-tabler-square-toggle-horizontal">
              <path stroke="none" d="M0 0h24v24H0z" fill="none" />
              <path d="M22 12h-20" />
              <path d="M4 14v-8a2 2 0 0 1 2 -2h12a2 2 0 0 1 2 2v8" />
              <path d="M18 20a2 2 0 0 0 2 -2" />
              <path d="M4 18a2 2 0 0 0 2 2" />
              <path d="M14 20l-4 0" />
            </svg>
            Toggle layout
          </a>
          <a href="#" class="btn btn-secondary-outline d-md-none btn-icon" onclick="toggleLayout(this)">
            <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none"
              stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"
              class="icon icon-tabler icons-tabler-outline icon-tabler-square-toggle-horizontal">
              <path stroke="none" d="M0 0h24v24H0z" fill="none" />
              <path d="M22 12h-20" />
              <path d="M4 14v-8a2 2 0 0 1 2 -2h12a2 2 0 0 1 2 2v8" />
              <path d="M18 20a2 2 0 0 0 2 -2" />
              <path d="M4 18a2 2 0 0 0 2 2" />
              <path d="M14 20l-4 0" />
            </svg>
          </a>
          <a href="/uploadExcel/{{data.project.slug}}" class="btn btn-secondary-outline d-none d-md-inline-block">
            <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none"
              stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"
              class="icon icon-tabler icons-tabler-outline icon-tabler-upload">
              <path stroke="none" d="M0 0h24v24H0z" fill="none" />
              <path d="M4 17v2a2 2 0 0 0 2 2h12a2 2 0 0 0 2 -2v-2" />
              <path d="M7 9l5 -5l5 5" />
              <path d="M12 4l0 12" />
            </svg>
            Bulk Upload
          </a>
          <a href="/uploadExcel/{{data.project.slug}}" class="btn btn-secondary-outline d-md-none btn-icon">
            <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none"
              stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"
              class="icon icon-tabler icons-tabler-outline icon-tabler-upload">
              <path stroke="none" d="M0 0h24v24H0z" fill="none" />
              <path d="M4 17v2a2 2 0 0 0 2 2h12a2 2 0 0 0 2 -2v-2" />
              <path d="M7 9l5 -5l5 5" />
              <path d="M12 4l0 12" />
            </svg>
          </a>
          {{#if (findInArray data.role "editProject")}}
          <a href="#" class="btn btn-secondary-outline d-none d-md-inline-block"
            id="#edit-project-{{data.project.slug}}" data-bs-toggle="modal"
            data-bs-target="#modal-{{data.project.slug}}">
            Edit this project
          </a>
          <a href="#" class="btn btn-secondary-outline d-md-none btn-icon" data-bs-toggle="modal"
            data-bs-target="#modal-{{data.project.slug}}" aria-label="Create new report">
            <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none"
              stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"
              class="icon icon-tabler icons-tabler-outline icon-tabler-pencil-plus">
              <path stroke="none" d="M0 0h24v24H0z" fill="none" />
              <path d="M4 20h4l10.5 -10.5a2.828 2.828 0 1 0 -4 -4l-10.5 10.5v4" />
              <path d="M13.5 6.5l4 4" />
              <path d="M16 19h6" />
              <path d="M19 16v6" />
            </svg>
          </a>
          {{/if}}
          {{#if (findInArray data.role "createEntry")}}
          <a href="#" class="btn btn-primary d-none d-md-inline-block" id="#createNewEntry" data-bs-toggle="modal"
            data-bs-target="#modal-new-entry">
            <svg xmlns="http://www.w3.org/2000/svg" class="icon" width="24" height="24" viewBox="0 0 24 24"
              stroke-width="2" stroke="currentColor" fill="none" stroke-linecap="round" stroke-linejoin="round">
              <path stroke="none" d="M0 0h24v24H0z" fill="none" />
              <path d="M12 5l0 14" />
              <path d="M5 12l14 0" />
            </svg>
            Create new entry
          </a>
          <a href="#" class="btn btn-primary d-md-none btn-icon" data-bs-toggle="modal"
            data-bs-target="#modal-new-entry" aria-label="modal-new-entry">
            <!-- Download SVG icon from http://tabler-icons.io/i/plus -->
            <svg xmlns="http://www.w3.org/2000/svg" class="icon" width="24" height="24" viewBox="0 0 24 24"
              stroke-width="2" stroke="currentColor" fill="none" stroke-linecap="round" stroke-linejoin="round">
              <path stroke="none" d="M0 0h24v24H0z" fill="none" />
              <path d="M12 5l0 14" />
              <path d="M5 12l14 0" />
            </svg>
          </a>
          {{/if}}
        </div>
      </div>
    </div>
  </div>
</div>
<!-- Page body -->
<div class="container-xl pt-4" id="data-container">
  {{> showProject}}
</div>

{{#if (findInArray data.role "createEntry")}}
{{> emptyEntryModal}}
{{/if}}

{{#if (findInArray data.role "editProject")}}
{{> modalProject}}
{{/if}}

{{> projectsFrontEnd}}
{{> entryFrontEnd}}

<script>

  // Load the edit entry modal

  $(document).on("click", ".edit-entry", function (e) {

    const entryId = $(this).attr("entry-id");

    const modalExists = $(document).find(`#button-${entryId}`).length > 0;

    if (modalExists) {
      return $(`#button-${entryId}`).trigger("click");
    }

    $.ajax({
      url: `/getEntryModal/{{data.project.slug}}/${entryId}`,
      type: 'GET',
      contentType: 'application/json',
      success: function (response) {
        $("footer").before(response);
        $(`#button-${entryId}`).trigger("click");
        refreshImages();
        refreshFsLightbox();
      },
      error: function (xhr, status, error) {
        alert(xhr.responseText)
      }
    });

  })

  const defaultImageUrl = "/static/images/missing-image.png";

  const refreshImages = function () {
    $('img').each(function () {
      // Listen for the error event on each image
      $(this).on('error', function () {
        // Set the src to the default image if the original image fails to load
        $(this).attr('src', defaultImageUrl);
      });
    });
  }

  refreshImages();

  const toggleLayout = function (elem) {
    $.ajax({
      url: '/update-layout',
      method: 'POST',
      data: { layout: newLayout },
      success: function (response) {
        showData();
      },
      error: function () {
        alert("Failed to update layout.");
      }
    });
  }

  const showData = function () {
    const href = $('.page-item.active a').attr('my-href') || $("input[my-key='search']").attr("my-href") || "";
    $.ajax({
      url: `/getEntryData/{{data.project.slug}}${href}`,
      method: 'GET',
      success: function (response) {
        newLayout = newLayout == 'grid' ? 'table' : 'grid';
        $("#data-container").html(response);
        window.history.pushState(null, '', `/project/{{data.project.slug}}${href}`);
        refreshImages();
      },
      error: function (error) {
        alert(error.responseText);
      }
    });
  }

  // search features

  $(document).on("click", ".filters .dropdown-menu .dropdown-item", function (e) {
    e.preventDefault();

    const type = $(this).attr('my-type');
    const options = $(this).attr('my-options') ? $(this).attr('my-options').split(',') : [];

    const inputContainer = $(this).closest('.input-group').find('.form-control, .form-select');
    inputContainer.remove();

    let newInput;
    if (type === 'date') {
      newInput = `<input type="text" class="form-control dateInput" aria-label="search by date" placeholder="e.g > 2020" />`;
    } else if (type === 'boolean') {
      newInput = `<select class="form-select" aria-label="search by column name">
                        ${options.map(option => `<option value="${option}">${option}</option>`).join('')}
                    </select>`;
    } else if (type === 'number') {
      newInput = `<input type="number" class="form-control" aria-label="search by column name" placeholder="Only numbers">`;
    } else if (type === 'dropdown') {
      newInput = `<select class="form-select" aria-label="search by column name">
                ${options.map(option => `<option value="${option}">${option}</option>`).join('')}
            </select>`;
    } else if (type === 'string') {
      newInput = `<input type="text" class="form-control" aria-label="search by column name" placeholder="Enter value">`;
    } else {
      newInput = `<input type="text" class="form-control" aria-label="search by column name" placeholder="Enter value">`;
    }

    $(this).closest('.input-group').append(newInput);

    $(this).closest('.input-group').find('.dropdown-toggle').attr({ 'my-name': $(this).attr('my-name') }).text($(this).attr('my-actual-name'));
  });

  $(document).on('input', '.dateInput', function (event) {
    const inputValue = event.target.value.trim();

    // Regular expression to detect conditions like > Jan 2023, = 2023, etc.
    const conditionPattern = /^(>|<|>=|<=|=)?\s*(\d{1,2}\s+[A-Za-z]{3,9}\s+\d{4}|\d{4}|\s*[A-Za-z]{3,9}\s+\d{4})$/i;

    // Regular expression to detect various date formats (supporting full and short formats)
    const datePattern = /^(?:\d{1,2}\s+[A-Za-z]{3,9}(?:\s+\d{4})?|[A-Za-z]{3,9}\s+\d{1,2}\s+\d{4}|(?:\d{4})\s+[A-Za-z]{3,9}\s+\d{1,2})$/i;

    // Check if the input matches a condition pattern (e.g., '> Jan 2023', '<= 2024')
    if (conditionPattern.test(inputValue)) {

      console.log("Valid date detected: ", inputValue);  // Handle valid date formats like '20 Jan 2023', '2023 Jan 20', etc.
      const query = parseDateCondition(inputValue, conditionPattern);
      if (query) {
        console.log("MongoDB query: ", query.date);  // Constructed MongoDB query
        $(this).attr('query', JSON.stringify(query.date));
        $(this).attr('stop-search', false);
        $(this).attr('stop-search-msg', "Valid date format");
      } else {
        $(this).attr('stop-search', true);
        $(this).attr('stop-search-msg', "Invalid date format");
      }

    }
    else {
      console.log("Invalid input");  // Invalid input
    }
  })

  function parseDateCondition(input, conditionPattern) {
    const match = input.trim().match(conditionPattern);

    if (match) {

      const operator = match[1] || "=";  // Default to equality (=) if no operator is provided
      const dateStr = match[2].trim();
      let date;

      // Case 1: If the input is just a year (e.g., "2023")
      if (/^\d{4}$/.test(dateStr)) {  // Only a year (e.g., "2023")
        date = new Date(`${dateStr}-01-01T00:00:00.000Z`);  // Start of the year
      }
      // Case 2: If the input is "Month Day Year" (e.g., "20 Jan 2023")
      else if (/^\d{1,2}\s+[A-Za-z]{3,9}\s+\d{4}$/.test(dateStr)) {  // Example: "20 Jan 2023"
        const [day, month, year] = dateStr.split(" ");
        const months = {
          Jan: 0, Feb: 1, Mar: 2, Apr: 3, May: 4, Jun: 5,
          Jul: 6, Aug: 7, Sep: 8, Oct: 9, Nov: 10, Dec: 11
        };
        const monthIndex = months[month];
        date = new Date(Date.UTC(year, monthIndex, day));  // UTC date to avoid timezone issues
      }
      // Case 3: If the input is "Month Year" (e.g., "Jan 2023")
      else if (/^[A-Za-z]{3,9}\s+\d{4}$/.test(dateStr)) {  // Example: "Jan 2023"
        const [month, year] = dateStr.split(" ");
        const months = {
          Jan: 0, Feb: 1, Mar: 2, Apr: 3, May: 4, Jun: 5,
          Jul: 6, Aug: 7, Sep: 8, Oct: 9, Nov: 10, Dec: 11
        };
        const monthIndex = months[month];
        date = new Date(Date.UTC(year, monthIndex, 1));  // Start of the month
      }

      if (date == "Invalid Date") {
        console.log("Invalid date format");
        return null;
      }

      // Construct the MongoDB query based on the operator
      let query = {};
      switch (operator) {
        case ">":
          query.date = { $gt: date };
          break;
        case ">=":
          query.date = { $gte: date };
          break;
        case "<":
          query.date = { $lt: date };
          break;
        case "<=":
          query.date = { $lte: date };
          break;
        case "=":
        default:
          query.date = { $eq: date };
          break;
      }

      return query;
    }

    return null;
  }

  const doFilterSearch = function (elem) {

    const parentElem = $(elem).closest(".filters");

    const searchField = $(parentElem).find(".dropdown-toggle").attr('my-name');
    const valueElem = $(parentElem).find(".input-group input, .input-group select");
    if (valueElem.attr('stop-search') == true) {
      alert(valueElem.attr('stop-search-msg'));
      return;
    }

    const searchValue = valueElem.hasClass('dateInput') ? valueElem.attr('query') : valueElem.val().trim();
    const sortBy = $(parentElem).find(".sortBy .form-select").val();
    const orderBy = $(parentElem).find("input[name='btn-radio-basic']:checked").attr("id") === "btn-radio-basic-1" ? "asc" : "desc";

    const href = $(elem).attr("my-href") + `&sortBy=${encodeURIComponent(sortBy)}&orderBy=${orderBy}&${encodeURIComponent(searchField)}=${encodeURIComponent(searchValue)}`;

    doSearch(elem, href);

  }

  const doSearch = function (elem, href) {
    if (!href) {
      href = $(elem).attr("my-href");
    }
    $.ajax({
      url: `/getEntryData/{{data.project.slug}}${href}`,
      method: 'GET',
      success: function (response) {
        $("#data-container").html(response);
        window.history.pushState(null, '', `/project/{{data.project.slug}}${href}`);
        refreshImages();
        refreshFsLightbox();
      },
      error: function (error) {
        alert(error.responseText);
      }
    });
  }

  $(document).on('keypress', '[my-href]', function (e) {
    if (e.which === 13 || e.keyCode === 13) {

      e.preventDefault();

      const href = $(this).attr("my-href");
      const key = $(this).attr("my-key");
      const value = $(this).val();
      const regex = new RegExp(`${key}=([^&]*)`, "g");
      const updatedHref = href.replace(regex, `${key}=${value}`);

      doSearch('', updatedHref);

    }
  });

  // refresh containers

  const refreshContainers = function () {
    $('.page-item.active > a').click();
  }

</script>